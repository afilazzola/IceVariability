---
title: "An examination of models of ice cover"
author: "Alessandro Filazzola"
date: "11/18/2020"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
---

![](lakeice.jpg)
Image by <a href="https://pixabay.com/photos/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1149223">Free-Photos</a> from <a href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1149223">Pixabay</a>

### Collaborators
- Alessandro Filazzola (University of Toronto and York University)
- Sapna Sharma (York University)
- R. Iestyn Woolway (European Space Agency)
- M. Arshad Imrit (York University)


### Objective
- Evaluate patterns models of ice coverage globally with climate change

### Load packages
```{r warning=FALSE, message=FALSE}
library(raster)
library(ncdf4)
library(tidyverse)
library(ggthemes)
library(doParallel)
library(foreach)

source("functions.r")

```


### Read in files
```{r warning=FALSE, message=FALSE}
allfiles <- list.files("data//isimip_ice", full.names = T)

## Lake Characteristics
lakeChar <- raster("data//isimip_lake_info2.nc")

## Take a look at a raster
viewSample <- stack(allfiles[1])
plot(viewSample[[1]])
```

albm_gfdl-esm2m_historical_rcp26_iceend 1901 to 2099
![](SamplePatterns.gif)

### Create models with difference 
```{r}
iceOnFiles <- allfiles[grep("icestart", allfiles)]
iceEndFiles <- allfiles[grep("iceend", allfiles)]

## get model names
allmodels <- iceOnFiles %>% gsub(".*_ice/", "", .) %>% gsub("_historical.*", "", .)
GCMmodels <- gsub(".*_", "", allmodels)
lakemodels <- gsub("_.*", "", allmodels)
RCPmodels <- iceOnFiles %>% gsub(".*historical_", "", .) %>% gsub("_icestart.*", "", .)

## Convert models to text
models <- data.frame(lakemodel = lakemodels, GCM = GCMmodels, RCP = RCPmodels, filepath=iceOnFiles, stringsAsFactors = F)


### Run through all ice on models

iceStartLat <- foreach(j = 1:nrow(models), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel")) %do% {

  ## Select subset of models
iterModel <- subset(models, filepath == models$filepath[j])
    
## Select time periods
iterCurrent <- stack(iterModel[,"filepath"], bands=70:99)
iterFuture <- stack(iterModel[,"filepath"], bands=170:199)

## Calculate means
meanCurrent <- mean(iterCurrent)
meanFuture <- mean(iterFuture)

## Determine difference
diffFuture <- (meanFuture-meanCurrent)

newName <- basename(iterModel[,"filepath"]) %>% gsub("_1901_2099", "", .)%>% gsub("historical_", "", .)
writeRaster(diffFuture, paste0("data//diffRasters//diff_",newName))
}


## get model names
allmodels <- iceEndFiles %>% gsub(".*_ice/", "", .) %>% gsub("_historical.*", "", .)
GCMmodels <- gsub(".*_", "", allmodels)
lakemodels <- gsub("_.*", "", allmodels)
RCPmodels <- iceEndFiles %>% gsub(".*historical_", "", .) %>% gsub("_icestart.*", "", .)

## Convert models to text
models <- data.frame(lakemodel = lakemodels, GCM = GCMmodels, RCP = RCPmodels, filepath=iceEndFiles, stringsAsFactors = F)


### Run through all ice end models

iceStartLat <- foreach(j = 1:nrow(models), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel")) %do% {

  ## Select subset of models
iterModel <- subset(models, filepath == models$filepath[j])
    
## Select time periods
iterCurrent <- stack(iterModel[,"filepath"], bands=70:99)
iterFuture <- stack(iterModel[,"filepath"], bands=170:199)

## Calculate means
meanCurrent <- mean(iterCurrent)
meanFuture <- mean(iterFuture)

## Determine difference
diffFuture <- (meanFuture-meanCurrent)

newName <- basename(iterModel[,"filepath"]) %>% gsub("_1901_2099", "", .)%>% gsub("historical_", "", .)
writeRaster(diffFuture, paste0("data//diffRasters//diff_",newName))
}


models


### Identify areas with ice loss 
iceStartLat <- foreach(j = 1:nrow(models), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel","tidyverse")) %do% {

  ## Select subset of models
iterModel <- subset(models, filepath == models$filepath[j])
    
## Select time periods
iterCurrent <- stack(iterModel[,"filepath"], bands=70:99)
iterFuture <- stack(iterModel[,"filepath"], bands=170:199)

## Calculate means
meanCurrent <- reclassify(mean(iterCurrent), rcl= data.frame(from = c(-999,0), to=c(0,999), becomes=c(0,1)))
meanFuture <- reclassify(mean(iterFuture), rcl= data.frame(from = c(-999,0), to=c(0,999), becomes=c(0,1)))

areaCurrent <- area(meanCurrent, na.rm=T)
totalareaCurrent <- sum(values(areaCurrent), na.rm=T)
areaFuture <- area(meanFuture, na.rm=T)
totalareaFuture <- sum(values(areaFuture), na.rm=T)

## Relative Diff
perAreaChange <-   100 - round(totalareaFuture/totalareaCurrent,4)*100

## Missing ice

## Convert the dataframe to plot properly 
meanCurrentDF <- as(meanCurrent, "SpatialPixelsDataFrame")
meanCurrentDF <- as.data.frame(meanCurrentDF)
colnames(meanCurrentDF) <- c("value", "x", "y")
meanFutureDF <- as(meanFuture, "SpatialPixelsDataFrame")
meanFutureDF <- as.data.frame(meanFutureDF)
colnames(meanFutureDF) <- c("value", "x", "y")

world <- map_data("world")
plotOut <- ggplot() +  geom_map(data=world, map = world, aes(long, lat, map_id = region), fill = "darkgray") +theme_Publication() +
  geom_tile(data= meanCurrentDF , aes(x=x, y=y), fill="#00008B")+
  geom_tile(data= meanFutureDF , aes(x=x, y=y), fill="#72bcd4") + 
  annotate(geom="text", x=-160, y=85, label=paste0("Percent change in area = ",round(perAreaChange,2))) +
  annotate(geom="text", x=-160, y=90, label=paste0("Model = ",iterModel$lakemodel," ",iterModel$GCM," ", iterModel$RCP)) +
  ylab("Latitude") + xlab("Longitude") + xlim(-180,180) + ylim(20,90)
plotOut

suppressWarnings({ 
ggsave(paste0("data//iceLossFigures//",iterModel$lakemodel,iterModel$GCM,iterModel$RCP,".png"),
       plot=plotOut, width=14)
})
}

```

### Plot general anomalies between time periods
```{r}
icediff <- list.files("data//diffRasters", full.names = T)


## create function for plot
getModelMap <- function(condition1, condition2, condition3,condition4){

    
## Select specified time window 
conditions <- paste0("(?=.*",condition1,")(?=.*",condition2,")(?=.*",condition3,")(?=.*",condition4,")")
iceOnAno <- icediff[grep(conditions,iceOndiff, perl=T)] 
currentIce <- allfiles[grep(conditions,icediff, perl=T)] 

## select models and take average difference 
allDiff <- stack(iceOnAno)
modelDiff <- mean(allDiff)


## Convert the dataframe to plot properly 
modelDiffDF <- as(modelDiff, "SpatialPixelsDataFrame")
modelDiffDF <- as.data.frame(modelDiffDF)
colnames(modelDiffDF) <- c("value", "x", "y")


world <- map_data("world")
plotOut <- ggplot() +  geom_map(data=world, map = world, aes(long, lat, map_id = region), fill = "darkgray") +theme_Publication() +
  geom_tile(data= modelDiffDF , aes(x=x, y=y, fill=value)) +
  scale_fill_gradient2(  low = "yellow", mid = "orange", high="red", midpoint = 15) + 
  xlab("Longitude") + ylab("Latitude")+ 
  theme(legend.position = c(0.1, 0.3),legend.direction = "vertical", legend.title = element_blank(),legend.key.height = unit(0.5,"cm")) +
  xlim(-180,180) + ylim(20,90)+
  annotate(geom="text", x=-160, y=90, label=paste0("Model = ",condition1," ",condition2," ", condition3," ", condition4))

return(plotOut)
}

iceMeasure <- c("icestart","iceend")
gcms <- unique(GCMmodels)
rcps <- c("rcp26","rcp60","rcp85")
lakemod <- unique(lakemodels)
models2 <- expand.grid(iceMeasure, gcms, rcps,lakemod)


foreach(j = 1:nrow(models2), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel","tidyverse")) %do% {

maps <- getModelMap(models2[j,1],models2[j,2],models2[j,3],models2[j,4])
suppressWarnings({ 
ggsave(paste0("data//iceDiffFigures//",models2[j,1],models2[j,2],models2[j,3],models2[j,4],".png"),
       plot=maps, width=14)
})
  
}

### Ice off
## Select ice start only
iceEndAno <- icediff[grep( "iceend",iceOndiff)] 
iceEndAno95 <- iceEndAno[grep("rcp85",iceEndAno)]

## get model names
allmodels <- iceEndAno95  %>% basename() %>% gsub("diff_", "", .) %>%  gsub(".*_ice/", "", .) 
lakemodels <- gsub("_.*", "", allmodels)

## select models and take average difference 
allDiff <- stack(iceEndAno95[-8])
modelDiff <- mean(allDiff)

## Convert the dataframe to plot properly 
modelDiffDF <- as(modelDiff, "SpatialPixelsDataFrame")
modelDiffDF <- as.data.frame(modelDiffDF)
colnames(modelDiffDF) <- c("value", "x", "y")



world <- map_data("world")
ggplot() +  geom_map(data=world, map = world, aes(long, lat, map_id = region), fill = "darkgray") +theme_Publication() +
  geom_tile(data= modelDiffDF , aes(x=x, y=y, fill=value)) +
  scale_fill_gradient2(  low = "red", mid = "orange", high="yellow", midpoint = -15) + 
  xlab("Longitude") + ylab("Latitude")+ 
  theme(legend.position = c(0.1, 0.3),legend.direction = "vertical", legend.title = element_blank(),legend.key.height = unit(0.5,"cm")) +
  xlim(-180,180) + ylim(-90,90)



```


### Average patterns among models
```{r}
iceOnFiles <- allfiles[grep("icestart", allfiles)]
iceEndFiles <- allfiles[grep("iceend", allfiles)]

## get model names
allmodels <- iceOnFiles %>% gsub(".*_ice/", "", .) %>% gsub("_historical.*", "", .)
GCMmodels <- gsub(".*_", "", allmodels)
lakemodels <- gsub("_.*", "", allmodels)
RCPmodels <- iceOnFiles %>% gsub(".*historical_", "", .) %>% gsub("_icestart.*", "", .)

## Convert models to text
modelsOn <- data.frame(lakemodel = lakemodels, GCM = GCMmodels, RCP = RCPmodels, filepath=iceOnFiles, stringsAsFactors = F)


### Run through all ice on models

iceStartDate <- foreach(j = 1:nrow(models), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel")) %do% {
  
  ## Select subset of models
  iterModel <- subset(models, filepath == models$filepath[j])
  
  ## Select time periods
  iterCurrent <- stack(iterModel[,"filepath"], bands=70:99)
  iterFuture <- stack(iterModel[,"filepath"], bands=170:199)
  
  ## Calculate means
  meanCurrent <- mean(iterCurrent)
  meanFuture <- mean(iterFuture)
  
  ## Determine difference
  modelOut <- data.frame(lakemodel = iterModel[1,1], GCM = iterModel[1,2],RCP = iterModel[1,3],
                         historicMean = mean(values(meanCurrent), na.rm=T),historicSD = sd(values(meanCurrent), na.rm=T),
                         futureMean = mean(values(meanFuture), na.rm=T),futureSD = sd(values(meanFuture), na.rm=T))
  
 modelOut
}

## get model names
allmodels <- iceEndFiles %>% gsub(".*_ice/", "", .) %>% gsub("_historical.*", "", .)
GCMmodels <- gsub(".*_", "", allmodels)
lakemodels <- gsub("_.*", "", allmodels)
RCPmodels <- iceEndFiles %>% gsub(".*historical_", "", .) %>% gsub("_icestart.*", "", .)

## Convert models to text
modelsEnd <- data.frame(lakemodel = lakemodels, GCM = GCMmodels, RCP = RCPmodels, filepath=iceEndFiles, stringsAsFactors = F)


iceEndDate <- foreach(j = 1:nrow(modelsEnd), .combine=rbind, .packages=c("raster","ncdf4","dplyr","doParallel")) %do% {
  
  ## Select subset of models
  iterModel <- subset(modelsEnd, filepath == modelsEnd$filepath[j])
  
  ## Select time periods
  iterCurrent <- stack(iterModel[,"filepath"], bands=70:99)
  iterFuture <- stack(iterModel[,"filepath"], bands=170:199)
  
  ## Calculate means
  meanCurrent <- mean(iterCurrent)
  meanFuture <- mean(iterFuture)
  
  ## Determine difference
  modelOut <- data.frame(lakemodel = iterModel[1,1], GCM = iterModel[1,2],RCP = iterModel[1,3],
                         historicMean = mean(values(meanCurrent), na.rm=T),historicSD = sd(values(meanCurrent), na.rm=T),
                         futureMean = mean(values(meanFuture), na.rm=T),futureSD = sd(values(meanFuture), na.rm=T))
  
 modelOut
}

## Ice Start Patterns
iceStartDateLong <- iceStartDate %>%  select(-historicSD, futureSD) %>% gather(timeframe, meanStart, 4:5)

ggplot(iceStartDateLong, aes(x= lakemodel, y=meanStart, fill=timeframe)) + geom_bar( stat="identity",position="dodge") + facet_grid(RCP~GCM) + scale_fill_manual(values=c("#E69F00", "#56B4E9")) + theme_classic()

## Ice End Patterns
iceEndDateLong <- iceEndDate %>%  select(-historicSD, futureSD) %>% gather(timeframe, meanEnd, 4:5)

ggplot(iceEndDateLong, aes(x= lakemodel, y=meanEnd, fill=timeframe)) + geom_bar( stat="identity",position="dodge") + facet_grid(RCP~GCM) + scale_fill_manual(values=c("#E69F00", "#56B4E9")) + theme_classic()

```
